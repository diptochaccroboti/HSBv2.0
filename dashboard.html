<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Patient Info</title>
  <link rel="stylesheet" href="dashboardcss.css">
  <style>
    table {
      table-layout: fixed;
      width: 100%; /* Ensure it spans the entire container */
    }

    /* Loader animation for the download button */
    .download-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Make the download button disabled during the loading state */
    .btn-download:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by Patient ID" />
        <button id="searchBtn">Search</button>
      </div>
      <button id="addInjectionBtn" class="btn-add-injection">Add Injection</button>
      <!-- Download PDF Button -->
      <button id="downloadPdfBtn" class="btn-download"><span class="loader"></span> </button>
    </header>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Patient ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Factor Type</th>
            <th>Factor Level</th>
            <th>Phone</th>
            <th>Home Town</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="patientsTable">
          <!-- Patient rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal for Editing Patient Info -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">Edit Patient Information</div>
      <div class="modal-body">
        <input type="hidden" id="editPatientId" />
        <label for="editName">Name:</label>
        <input type="text" id="editName" />
        <label for="editAge">Age:</label>
        <input type="number" id="editAge" />
        <label for="editFactorType">Factor Type:</label>
        <select id="editFactorType">
          <option value="Factor 8">Factor 8</option>
          <option value="Factor 9">Factor 9</option>
          <option value="Factor Level VWD"> VWD</option>
          <option value="Others">Others</option>
        </select>
        <label for="editFactorLevel">Factor Level:</label>
        <input type="text" id="editFactorLevel" />
        <label for="editPhone">Phone:</label>
        <input type="tel" id="editPhone" />
        <label for="editHometown">Home Town:</label>
        <input type="text" id="editHometown" />
      </div>
      <div class="modal-footer">
        <button class="btn-save" id="saveBtn">Save Changes</button>
        <button class="btn-cancel" id="cancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDiYYd00e0tuP04Rh9yMRyY1n29AdVxy0s",
      authDomain: "hsb-patient-info-server.firebaseapp.com",
      projectId: "hsb-patient-info-server",
      storageBucket: "hsb-patient-info-server.firebasestorage.app",
      messagingSenderId: "961640364490",
      appId: "1:961640364490:web:fe98a28850659e7cf3f733"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const patientsRef = ref(db, 'patients');

    // Function to render all patients in the table with Edit and Delete buttons per row
    function renderPatients(snapshot) {
      const tbody = document.getElementById('patientsTable');
      tbody.innerHTML = ''; // Clear existing data
      snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val();
        const tr = document.createElement('tr');
        tr.innerHTML = ` 
          <td>${data.patientId}</td>
          <td>${data.name}</td>
          <td>${data.age}</td>
          <td>${data.factorType}</td>
          <td>${data.factorLevel}</td>
          <td>${data.phone}</td>
          <td>${data.hometown}</td>
          <td>
            <button class="edit-btn" data-id="${data.patientId}">Edit</button> 
            <button class="delete-btn" data-id="${data.patientId}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Add event listeners for all Edit and Delete buttons
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const patientId = e.target.getAttribute('data-id');
          openEditModal(patientId);
        });
      });

      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const patientId = e.target.getAttribute('data-id');
          deletePatient(patientId);
        });
      });
    }

    // Fetch and display patients in real-time
    onValue(patientsRef, (snapshot) => {
      renderPatients(snapshot);
    });

    // Search functionality (find patient by ID)
    document.getElementById("searchBtn").addEventListener("click", () => {
      const searchValue = document.getElementById("searchInput").value.trim();
      if (!searchValue) {
        alert("Please enter a Patient ID to search.");
        return;
      }

      get(patientsRef).then((snapshot) => {
        const tbody = document.getElementById('patientsTable');
        tbody.innerHTML = ''; // Clear previous results

        let found = false;
        snapshot.forEach(childSnapshot => {
          const data = childSnapshot.val();
          if (data.patientId === searchValue) {  // Match by Patient ID
            found = true;
            const tr = document.createElement('tr');
            tr.innerHTML = ` 
              <td>${data.patientId}</td>
              <td>${data.name}</td>
              <td>${data.age}</td>
              <td>${data.factorType}</td>
              <td>${data.factorLevel}</td>
              <td>${data.phone}</td>
              <td>${data.hometown}</td>
              <td>
                <button class="edit-btn" data-id="${data.patientId}">Edit</button>
                <button class="delete-btn" data-id="${data.patientId}">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);

            // Attach event for Edit button in the search result
            tr.querySelector(".edit-btn").addEventListener("click", () => {
              openEditModal(data.patientId);
            });
            // Attach event for Delete button in the search result
            tr.querySelector(".delete-btn").addEventListener("click", () => {
              deletePatient(data.patientId);
            });
          }
        });

        if (!found) {
          tbody.innerHTML = '<tr><td colspan="8">No patient found with this ID.</td></tr>';
        }
      }).catch((error) => {
        console.error("Error fetching patient data:", error);
      });
    });

    // Modal Elements
    const editModal = document.getElementById('editModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Open Edit Modal & Populate Fields
    function openEditModal(patientId) {
      // Get patient data from Firebase
      const patientRef = ref(db, `patients/${patientId}`);
      get(patientRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          document.getElementById('editPatientId').value = data.patientId;
          document.getElementById('editName').value = data.name;
          document.getElementById('editAge').value = data.age;
          document.getElementById('editFactorType').value = data.factorType;
          document.getElementById('editFactorLevel').value = data.factorLevel;
          document.getElementById('editPhone').value = data.phone;
          document.getElementById('editHometown').value = data.hometown;
          editModal.classList.add('active');
        } else {
          alert("Patient not found.");
        }
      }).catch((error) => {
        console.error("Error fetching patient data:", error);
      });
    }

    // Close modal when cancel is clicked
    cancelBtn.addEventListener('click', () => {
      editModal.classList.remove('active');
    });

    // Save Changes to Firebase
    saveBtn.addEventListener('click', () => {
      const patientId = document.getElementById('editPatientId').value;
      const updatedData = {
        name: document.getElementById('editName').value,
        age: document.getElementById('editAge').value,
        factorType: document.getElementById('editFactorType').value,
        factorLevel: document.getElementById('editFactorLevel').value,
        phone: document.getElementById('editPhone').value,
        hometown: document.getElementById('editHometown').value
      };
      update(ref(db, 'patients/' + patientId), updatedData)
        .then(() => {
          alert("Patient information updated successfully!");
          editModal.classList.remove('active');
        })
        .catch((error) => {
          console.error("Error updating patient data:", error);
        });
    });

    // Function to delete a patient from Firebase
    function deletePatient(patientId) {
      if (confirm("Are you sure you want to delete this patient?")) {
        const patientRef = ref(db, `patients/${patientId}`);
        remove(patientRef)
          .then(() => {
            alert("Patient deleted successfully!");
          })
          .catch((error) => {
            console.error("Error deleting patient data:", error);
          });
      }
    }

    // PDF Download Button with Animation
    document.getElementById("downloadPdfBtn").addEventListener("click", () => {
      // Show loading animation and disable the button
      const downloadBtn = document.getElementById("downloadPdfBtn");
      downloadBtn.disabled = true; // Disable the button to prevent multiple clicks

      // Create and append the loading spinner
      const spinner = document.createElement("div");
      spinner.classList.add("download-loading");
      document.body.appendChild(spinner);

      // Initialize jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 20;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(8); // Set smaller font size for better fitting

      doc.text("Patient Information Report HEMOPHILIA SOCIETY OF BANGLADESH", 4, y);
      y += 10;

      // Custom row for PDF only (this will be the first row in the PDF)
      const customHeader = ["Patient ID", "Name", "Age", "Factor Type", "Factor Level", "Phone", "Home Town"];
      
      // Prepare table data (excluding the header)
      const data = [];
      for (let i = 1; i < document.getElementById("patientsTable").rows.length; i++) {
        const rowData = [];
        for (let j = 0; j < document.getElementById("patientsTable").rows[i].cells.length - 1; j++) { // Exclude the last "Actions" cell
          rowData.push(document.getElementById("patientsTable").rows[i].cells[j].innerText);
        }
        data.push(rowData);
      }

      // Define table properties
      const tableWidth = 180; // Adjust table width to avoid overflow
      const columnWidth = tableWidth / customHeader.length; // Default equal column width
      const nameColumnWidth = 60; // Increased width for the "Name" column (optional)
      const cellHeight = 6; // Smaller row height for compactness
      const marginLeft = 3; // Left margin

      // Adjust "Name" column width specifically
      const columnWidths = customHeader.map((header, index) => {
        return index === 1 ? nameColumnWidth : columnWidth; // Increase "Name" column width if necessary
      });

      // Draw custom header row in PDF (first row only in PDF)
      doc.setTextColor(0, 0, 0); // Black text color
      customHeader.forEach((header, index) => {
        const xPosition = marginLeft + columnWidths.slice(0, index).reduce((a, b) => a + b, 0);
        doc.rect(xPosition, y, columnWidths[index], cellHeight); // Draw cell border
        doc.text(header, xPosition + 2, y + 4); // Text inside cell, with a small padding
      });
      y += cellHeight;

      // Draw data rows
      data.forEach((row) => {
        row.forEach((cell, index) => {
          const xPosition = marginLeft + columnWidths.slice(0, index).reduce((a, b) => a + b, 0);
          doc.rect(xPosition, y, columnWidths[index], cellHeight); // Draw cell border
          doc.text(cell, xPosition + 2, y + 4); // Text inside cell with padding
        });
        y += cellHeight;
      });

      // Simulate a download delay (you can remove this if you don't need the delay)
      setTimeout(() => {
        // Download the generated PDF
        doc.save("patients_report.pdf");

        // Hide the loading spinner and enable the button after download
        document.body.removeChild(spinner);
        downloadBtn.disabled = false; // Enable the button again
      }, 1500); // 1.5 seconds delay before triggering download
    });
  </script>
</body>
</html>
